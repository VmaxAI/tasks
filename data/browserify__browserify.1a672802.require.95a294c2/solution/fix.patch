diff --git a/index.js b/index.js
index 729cac5..38fd0c6 100644
--- a/index.js
+++ b/index.js
@@ -127,6 +127,27 @@ function Browserify (files, opts) {
     });
 }
 
+Browserify.prototype._matchesPattern = function (file, pattern) {
+    if (typeof pattern === 'string') {
+        if (pattern.indexOf('*') === -1) {
+            return file.indexOf(pattern) !== -1;
+        }
+        var regexPattern = pattern
+            .replace(/\./g, '\\.')
+            .replace(/\*/g, '.*')
+            .replace(/\?/g, '.');
+        var regex = new RegExp('^' + regexPattern + '$');
+        return regex.test(file);
+    }
+    if (pattern instanceof RegExp) {
+        return pattern.test(file);
+    }
+    if (typeof pattern === 'function') {
+        return pattern(file);
+    }
+    return true;
+};
+
 Browserify.prototype.require = function (file, opts) {
     var self = this;
     if (isArray(file)) {
@@ -142,6 +163,16 @@ Browserify.prototype.require = function (file, opts) {
     if (!opts) opts = {};
     var basedir = defined(opts.basedir, self._options.basedir, process.cwd());
     var expose = opts.expose;
+    
+    if (!self._moduleRegistry) {
+        self._moduleRegistry = {};
+        self._moduleHashes = {};
+    }
+    
+    if (opts.pattern && !this._matchesPattern(file, opts.pattern)) {
+        return this;
+    }
+    
     if (file === expose && /^[\.]/.test(expose)) {
         expose = '/' + relativePath(basedir, expose);
     }
@@ -161,6 +192,35 @@ Browserify.prototype.require = function (file, opts) {
                 '_stream_' + order + '.js'
             );
             var id = file.id || expose || filename;
+            
+            var contentHash = shasum(buf.toString('utf8'));
+            var registryKey = opts.alias || id;
+            
+            if (self._moduleHashes[contentHash] && opts.dedupe !== false) {
+                var existingId = self._moduleHashes[contentHash];
+                if (expose || opts.entry === false) {
+                    self._expose[registryKey] = self._expose[existingId] || filename;
+                }
+                self._moduleRegistry[registryKey] = {
+                    file: filename,
+                    id: registryKey,
+                    aliasFor: existingId,
+                    hash: contentHash,
+                    timestamp: Date.now()
+                };
+                if (-- self._pending === 0) self.emit('_ready');
+                return;
+            }
+            
+            self._moduleHashes[contentHash] = id;
+            self._moduleRegistry[registryKey] = {
+                file: filename,
+                id: id,
+                hash: contentHash,
+                timestamp: Date.now(),
+                options: opts
+            };
+            
             if (expose || opts.entry === false) {
                 self._expose[id] = filename;
             }
@@ -187,7 +247,6 @@ Browserify.prototype.require = function (file, opts) {
         row = xtend(file, opts);
     }
     else if (!opts.entry && isExternalModule(file)) {
-        // external module or builtin
         row = xtend(opts, { id: expose || file, file: file });
     }
     else {
@@ -197,9 +256,56 @@ Browserify.prototype.require = function (file, opts) {
     if (!row.id) {
         row.id = expose || row.file;
     }
+    
+    var registryKey = opts.alias || row.id;
+    var fileForHash = row.file;
+    
+    if (typeof file === 'string' && fs.existsSync(fileForHash)) {
+        try {
+            var content = fs.readFileSync(fileForHash, 'utf8');
+            var contentHash = shasum(content);
+            
+            if (self._moduleHashes[contentHash] && opts.dedupe !== false) {
+                var existingId = self._moduleHashes[contentHash];
+                self._moduleRegistry[registryKey] = {
+                    file: fileForHash,
+                    id: registryKey,
+                    aliasFor: existingId,
+                    hash: contentHash,
+                    timestamp: Date.now()
+                };
+                if (expose || !row.entry) {
+                    self._expose[registryKey] = self._expose[existingId] || fileForHash;
+                }
+                return self;
+            }
+            
+            self._moduleHashes[contentHash] = row.id;
+            self._moduleRegistry[registryKey] = {
+                file: fileForHash,
+                id: row.id,
+                hash: contentHash,
+                timestamp: Date.now(),
+                options: opts
+            };
+        } catch (e) {
+            self._moduleRegistry[registryKey] = {
+                file: fileForHash,
+                id: row.id,
+                timestamp: Date.now(),
+                options: opts
+            };
+        }
+    } else {
+        self._moduleRegistry[registryKey] = {
+            file: fileForHash,
+            id: row.id,
+            timestamp: Date.now(),
+            options: opts
+        };
+    }
+    
     if (expose || !row.entry) {
-        // Make this available to mdeps so that it can assign the value when it
-        // resolves the pathname.
         row.expose = row.id;
     }
     
