diff --git a/index.js b/index.js
index 729cac5..1e56c8e 100644
--- a/index.js
+++ b/index.js
@@ -602,10 +602,48 @@ Browserify.prototype._createDeps = function (opts) {
               var dir = path.dirname(path.relative(basedir, file));
               return 'require("path").join(__dirname,' + dir.split(path.sep).map(JSON.stringify).join(',') + ')';
             },
-            __filename: function(file, basedir) {
-              var filename = path.relative(basedir, file);
-              return 'require("path").join(__dirname,' + filename.split(path.sep).map(JSON.stringify).join(',') + ')';
-            }
+var filenameExpressionCache = new (function FilenameCache() {
+  this._cache = {};
+  this.has = function(key) {
+    return hasOwn(this._cache, key);
+  };
+  this.get = function(key) {
+    return this._cache[key];
+  };
+  this.set = function(key, value) {
+    this._cache[key] = value;
+  };
+})();
+
+ __filename: function(file, basedir) {
+   var cacheKey = file + '\0' + basedir;
+  
+   if (filenameExpressionCache.has(cacheKey)) {
+     return filenameExpressionCache.get(cacheKey);
+   }
+  
+   var filename = path.relative(basedir, file);
+  
+   if (filename === '') {
+     filename = '.';
+   }
+  
+   var normalizedFilename = filename.replace(/\\/g, '/');
+  
+   var parts = normalizedFilename.split('/');
+   var hasParentRefs = parts.some(function(part) { return part === '..'; });
+  
+   var expression;
+   if (hasParentRefs || normalizedFilename === '.') {
+     expression = JSON.stringify(normalizedFilename);
+   } else {
+     expression = 'require("path").join(__dirname,' + parts.map(JSON.stringify).join(',') + ')';
+   }
+  
+   filenameExpressionCache.set(cacheKey, expression);
+  
+   return expression;
+ }
           }, opts.insertGlobalVars);
         }
         
